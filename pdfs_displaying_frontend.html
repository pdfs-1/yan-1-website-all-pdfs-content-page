<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>üìö PDF Stream</title>

  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap"
        rel="stylesheet"/>

  <style>
    /* --------------------------------------------------------------
       General layout & theme
    -------------------------------------------------------------- */
    * { box-sizing:border-box; margin:0; padding:0; }

    body {
      font-family:'Poppins',sans-serif;
      background:linear-gradient(135deg,#0f172a,#1e293b);
      color:#fff;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      align-items:center;
      padding-bottom:40px;
    }

    header{
      width:100%; padding:16px; text-align:center;
      background:rgba(255,255,255,0.08);
      backdrop-filter:blur(12px);
      box-shadow:0 4px 20px rgba(0,0,0,.3);
      font-size:1.5em; font-weight:600; color:#60a5fa;
      letter-spacing:1px;
    }

    /* --------------------------------------------------------------
       Search bar (single bar with back‚Äëbutton & toggle)
    -------------------------------------------------------------- */
    .search-wrapper{
      position:relative;
      width:92%; max-width:1300px;
      margin-top:12px;
      display:flex; align-items:center; gap:8px;
    }
    .search-wrapper input{
      flex:1;
      padding:6px 8px;
      border-radius:4px;
      border:none;
      font-size:0.9rem;
      background:#1e293b;
      color:#fff;
    }
    .search-wrapper button{
      background:#60a5fa;
      color:#fff;
      border:none;
      border-radius:4px;
      padding:6px 8px;
      cursor:pointer;
      font-size:0.85rem;
    }
    .search-wrapper .back-btn{
      background:#64748b;
      color:#fff;
      border:none;
      border-radius:4px;
      width:28px; height:28px;
      font-size:0.9rem;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .search-wrapper .back-btn.hidden{ display:none; }
    .search-wrapper .toggle-options{
      background:#64748b;
      color:#fff;
      border:none;
      border-radius:4px;
      width:28px; height:28px;
      font-size:0.9rem;
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
    }
    .search-wrapper .upload-btn{
      background:#64748b;
    }

    .search-options{
      position:absolute;
      top:100%; right:0;
      background:#1e293b;
      padding:6px 8px;
      border-radius:6px;
      display:flex; align-items:center; gap:8px;
      margin-top:4px;
      box-shadow:0 4px 12px rgba(0,0,0,.5);
    }
    .search-options.hidden{ display:none; }
    .search-options select{
      padding:4px 6px;
      border-radius:4px;
      border:none;
      background:#0f172a;
      color:#fff;
      font-size:0.85rem;
    }
    .search-options .close-options{
      background:#ef4444;
      color:#fff;
      border:none;
      border-radius:4px;
      width:24px; height:24px;
      font-size:0.9rem;
      cursor:pointer;
      display:flex; align-items:center; justify-content:center;
    }

    /* --------------------------------------------------------------
       Feed & cards
    -------------------------------------------------------------- */
    #feed{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
      gap:16px;
      width:92%; max-width:1300px;
      margin-top:24px;
    }

    .card{
      background:rgba(255,255,255,0.08);
      border-radius:16px;
      padding:14px;
      display:flex;
      flex-direction:column;
      transition:transform .25s ease,box-shadow .25s ease;
    }
    .card:hover{
      transform:translateY(-4px);
      box-shadow:0 8px 20px rgba(0,0,0,.4);
    }

    .preview{
      width:100%; aspect-ratio:16/9;
      border-radius:12px;
      overflow:hidden;
      background:#1e293b;
      display:flex; align-items:center; justify-content:center;
      color:#94a3b8; font-size:.9em;
      position:relative;
    }
    .preview iframe{ width:100%; height:100%; border:none; }

    .share-btn{
      position:absolute;
      top:4px; right:4px;
      background:rgba(0,0,0,.5);
      border:none; color:#fff;
      font-size:0.85rem;
      border-radius:4px;
      padding:2px 4px;
      cursor:pointer;
    }
    .share-btn:hover{ background:rgba(0,0,0,.7); }

    .info{ margin-top:10px; }
    .title{
      font-size:1em; font-weight:600; color:#f8fafc;
      margin-bottom:4px; line-height:1.4; word-break:break-word;
    }
    .meta{
      font-size:.85em; color:#94a3b8; word-break:break-word;
    }

    .open-btn{
      margin-top:10px; background:#60a5fa; color:#fff;
      border:none; border-radius:8px; padding:10px;
      font-weight:500; cursor:pointer;
      transition:background .25s ease; font-size:.95em;
    }
    .open-btn:hover{ background:#3b82f6; }

    footer{
      margin-top:30px; color:#94a3b8; font-size:.9em; text-align:center;
    }

    .loader{
      margin-top:60px;
      border:6px solid rgba(255,255,255,.2);
      border-top:6px solid #60a5fa;
      border-radius:50%; width:45px; height:45px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

    /* --------------------------------------------------------------
       Full‚Äëscreen PDF / Upload viewer
    -------------------------------------------------------------- */
    .pdf-viewer{
      position:fixed; top:0; left:0;
      width:100vw; height:100vh;
      background:#0f172a;
      z-index:999; display:none; flex-direction:column;
    }
    .pdf-viewer.active{ display:flex; }

    .pdf-toolbar{
      display:flex; justify-content:space-between; align-items:center;
      padding:10px 14px;
      background:rgba(15,23,42,.9);
      border-bottom:1px solid rgba(255,255,255,.1);
    }
    .pdf-toolbar h2{
      font-size:1em; color:#93c5fd; font-weight:500;
      overflow:hidden; text-overflow:ellipsis;
      white-space:nowrap; max-width:80%;
    }
    .close-full{
      background:#ef4444; border:none; color:#fff;
      font-size:1.2em; width:36px; height:36px;
      border-radius:50%; cursor:pointer;
      transition:background .25s ease;
    }
    .close-full:hover{ background:#dc2626; }
    .pdf-iframe{
      flex-grow:1; border:none; width:100%; height:100%;
    }

    /* --------------------------------------------------------------
       Responsiveness
    -------------------------------------------------------------- */
    @media(max-width:768px){
      header{font-size:1.3em;padding:12px}
      .open-btn{font-size:.9em;padding:8px}
      .meta{font-size:.8em}
    }
    @media(max-width:480px){
      #feed{width:96%;gap:12px}
      .card{padding:10px}
      .preview{aspect-ratio:4/3}
      .title{font-size:.95em}
      .pdf-toolbar h2{font-size:.9em}
      .close-full{width:32px;height:32px;font-size:1em}
      .search-wrapper{flex-wrap:wrap}
      .search-wrapper input{order:2; flex-basis:100%; margin-top:4px;}
    }
  </style>
</head>
<body>
  <!-- Header (empty ‚Äì title removed) -->
  <header></header>

  <!-- Search bar (single) -->
  <div class="search-wrapper">
    <button id="backBtn" class="back-btn hidden">‚Üê</button>
    <input type="text" id="searchInput" placeholder="Search title‚Ä¶" />
    <button id="searchBtn">Search</button>
    <!-- The upload button will be inserted here by script -->
    <button id="toggleOptions" class="toggle-options">‚Üí</button>

    <div id="searchOptions" class="search-options hidden">
      <select id="searchField">
        <option value="title">Title</option>
        <option value="id">ID</option>
        <option value="username">Username</option>
      </select>
      <button id="closeOptions" class="close-options">‚úï</button>
    </div>
  </div>

  <!-- Feed & loader -->
  <div id="feed"></div>
  <div id="loader" class="loader"></div>

  <footer>Powered by Archive &amp; Your Backend</footer>

  <!-- Full‚Äëscreen PDF viewer -->
  <div id="pdfViewer" class="pdf-viewer">
    <div class="pdf-toolbar">
      <h2 id="pdfTitle">PDF Viewer</h2>
      <button class="close-full" id="closeViewer">&times;</button>
    </div>
    <iframe id="pdfFrame" class="pdf-iframe" src=""></iframe>
  </div>

  <!-- Full‚Äëscreen upload viewer -->
  <div id="uploadOverlay" class="pdf-viewer">
    <div class="pdf-toolbar">
      <h2>Upload PDF</h2>
      <button class="close-full" id="closeUpload">&times;</button>
    </div>
    <iframe id="uploadFrame" class="pdf-iframe" src=""></iframe>
  </div>

  <script>
    (function () {
      /* ----------------- Global elements & state ----------------- */
      const FEED          = document.getElementById('feed');
      const LOADER        = document.getElementById('loader');
      const VIEWER        = document.getElementById('pdfViewer');
      const PDF_FRAME     = document.getElementById('pdfFrame');
      const PDF_TITLE     = document.getElementById('pdfTitle');
      const CLOSE_VIEWER  = document.getElementById('closeViewer');

      const UPLOAD_OVERLAY = document.getElementById('uploadOverlay');
      const UPLOAD_FRAME   = document.getElementById('uploadFrame');
      const CLOSE_UPLOAD   = document.getElementById('closeUpload');

      const SEARCH_INPUT   = document.getElementById('searchInput');
      const SEARCH_BTN     = document.getElementById('searchBtn');
      const BACK_BTN       = document.getElementById('backBtn');
      const TOGGLE_BTN     = document.getElementById('toggleOptions');
      const SEARCH_OPTIONS = document.getElementById('searchOptions');
      const SEARCH_FIELD   = document.getElementById('searchField');
      const CLOSE_OPTIONS  = document.getElementById('closeOptions');

      const BACKEND_URL    = 'https://pdfs_displaying_backend.video-api-ajaiahar.workers.dev';

      let allData   = [], currentIndex = 0;
      const BATCH_SIZE = 30;
      let loadingMore = false;
      let searchMode = false;

      /* ----------------- Helper: open PDF full‚Äëscreen ----------------- */
      function openFullscreenPDF(title, url) {
        if (!url) { console.warn('openFullscreenPDF called with empty URL'); return; }
        const embedUrl = url.includes('archive.org')
          ? url.replace('/details/', '/embed/')
          : url;
        PDF_TITLE.textContent = title || 'PDF Viewer';
        PDF_FRAME.src = embedUrl;
        VIEWER.classList.add('active');
      }

      /* ----------------- Helper: render a set of cards ----------------- */
      function renderCards(arr) {
        FEED.innerHTML = '';
        arr.forEach(item => createCard(item));
      }

      /* ----------------- Card creation (includes share) ----------------- */
      function createCard(item) {
        const card = document.createElement('div');
        card.className = 'card';

        const preview = document.createElement('div');
        preview.className = 'preview';

        if (item.archive_url && item.archive_url.includes('archive.org')) {
          const embedUrl = item.archive_url.replace('/details/', '/embed/');
          preview.innerHTML = `<iframe src="${embedUrl}" allowfullscreen></iframe>`;
        } else {
          preview.textContent = 'No Preview Available';
        }

        // Tiny share button (top‚Äëright corner of preview)
        const shareBtn = document.createElement('button');
        shareBtn.className = 'share-btn';
        shareBtn.title = 'Share';
        shareBtn.textContent = 'üîó';
        shareBtn.addEventListener('click', e => {
          e.stopPropagation();
          const link = `https://yan-1-related-1.github.io/yan-1-website-shared-links-redirecting/all-pdfs-content-page-shared-links-redirecting.html?pdf_id=${encodeURIComponent(item.id)}`;
          if (navigator.clipboard) {
            navigator.clipboard.writeText(link).then(() => alert('Link copied to clipboard'))
                                           .catch(() => prompt('Copy this link', link));
          } else {
            prompt('Copy this link', link);
          }
          if (navigator.share) {
            navigator.share({ title: item.title, url: link }).catch(() => {});
          }
        });
        preview.appendChild(shareBtn);

        const info = document.createElement('div');
        info.className = 'info';
        info.innerHTML = `
          <div class="title">${item.title || 'Untitled PDF'}</div>
          <div class="meta">üë§ ${item.username || 'Anonymous'} ‚Ä¢ üÜî ${item.id || 'N/A'}</div>
        `;

        const openBtn = document.createElement('button');
        openBtn.className = 'open-btn';
        openBtn.textContent = 'Open PDF';
        openBtn.onclick = () => {
          if (item.archive_url) openFullscreenPDF(item.title || 'Untitled PDF', item.archive_url);
          else console.warn('No archive URL for this PDF');
        };

        card.append(preview, info, openBtn);
        FEED.appendChild(card);
      }

      /* ----------------- Data fetching & initial rendering ----------------- */
      async function fetchData() {
        try {
          const res = await fetch(BACKEND_URL);
          const data = await res.json();
          LOADER.style.display = 'none';

          if (!data || data.length === 0) {
            FEED.innerHTML = "<p style='text-align:center;color:#94a3b8'>No PDFs found üò¢</p>";
            return;
          }

          allData = data.sort((a, b) => Number(b.id) - Number(a.id));

          const params = new URLSearchParams(window.location.search);
          const pdfId = params.get('pdf_id');
          if (pdfId) {
            const target = allData.find(it => String(it.id) === pdfId);
            if (target) openFullscreenPDF(target.title || 'Untitled PDF', target.archive_url);
            else { loadNextBatch(); window.addEventListener('scroll', handleScroll); }
          } else {
            loadNextBatch();
            window.addEventListener('scroll', handleScroll);
          }
        } catch (err) {
          LOADER.style.display = 'none';
          FEED.innerHTML = "<p style='text-align:center;color:#f87171'>Error loading data üòû</p>";
          console.error('fetchData error ‚Üí', err);
        }
      }

      /* ----------------- Infinite scroll batch loading ----------------- */
      function loadNextBatch() {
        if (loadingMore) return;
        loadingMore = true;

        const batch = allData.slice(currentIndex, currentIndex + BATCH_SIZE);
        batch.forEach(item => createCard(item));
        currentIndex += BATCH_SIZE;
        loadingMore = false;

        if (currentIndex >= allData.length) window.removeEventListener('scroll', handleScroll);
      }

      function handleScroll() {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        if (scrollTop + clientHeight >= scrollHeight - 10) loadNextBatch();
      }

      /* ----------------- Viewer close handling ----------------- */
      function closeViewer() {
        VIEWER.classList.remove('active');
        PDF_FRAME.src = '';
      }
      CLOSE_VIEWER.onclick = closeViewer;
      document.addEventListener('keydown', e => { if (e.key === 'Escape') closeViewer(); });

      /* ----------------- Upload overlay handling ----------------- */
      const uploadBtn = document.createElement('button');
      uploadBtn.id = 'uploadBtn';
      uploadBtn.className = 'upload-btn';
      uploadBtn.textContent = 'Upload';
      // Insert the upload button right before the toggle‚Äëoptions button
      document.querySelector('.search-wrapper').insertBefore(uploadBtn,
          document.getElementById('toggleOptions'));

      uploadBtn.addEventListener('click', () => {
        UPLOAD_FRAME.src = 'pdfs_uploading.html';
        UPLOAD_OVERLAY.classList.add('active');
      });
      CLOSE_UPLOAD.onclick = () => {
        UPLOAD_FRAME.src = '';
        UPLOAD_OVERLAY.classList.remove('active');
      };

      /* ----------------- Search handling ----------------- */
      SEARCH_BTN.addEventListener('click', performSearch);
      SEARCH_INPUT.addEventListener('keydown', e => { if (e.key === 'Enter') performSearch(); });

      function performSearch() {
        const term = SEARCH_INPUT.value.trim().toLowerCase();
        const field = SEARCH_FIELD.value; // title | id | username

        if (!term) { exitSearchMode(); return; }

        let results = [];
        if (field === 'title') {
          results = allData.filter(it => (it.title || '').toLowerCase().includes(term));
        } else if (field === 'id') {
          results = allData.filter(it => String(it.id).toLowerCase() === term);
        } else if (field === 'username') {
          results = allData.filter(it => (it.username || '').toLowerCase().includes(term));
        }

        searchMode = true;
        renderCards(results);
        BACK_BTN.classList.remove('hidden');
        window.removeEventListener('scroll', handleScroll);
      }

      BACK_BTN.addEventListener('click', exitSearchMode);

      function exitSearchMode() {
        if (!searchMode) return;
        searchMode = false;
        SEARCH_INPUT.value = '';
        BACK_BTN.classList.add('hidden');
        SEARCH_OPTIONS.classList.add('hidden');
        FEED.innerHTML = '';
        currentIndex = 0;
        loadNextBatch();
        window.addEventListener('scroll', handleScroll);
      }

      /* ----------------- Toggle advanced search options ----------------- */
      TOGGLE_BTN.addEventListener('click', () => {
        SEARCH_OPTIONS.classList.toggle('hidden');
      });
      CLOSE_OPTIONS.addEventListener('click', () => {
        SEARCH_OPTIONS.classList.add('hidden');
      });

      /* ----------------- Initialise ----------------- */
      document.addEventListener('DOMContentLoaded', () => {
        fetchData();
      });
    })();
  </script>
</body>
</html>
